<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wordz</title>
    <meta
      content="width=device-width, initial-scale=1, user-scalable=no"
      name="viewport"
    />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="yes" name="mobile-web-app-capable" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content="Wordz" />
    <meta name="application-name" content="Wordz" />
    <link href="styles.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="./word_indices.js"></script>
  </head>
  <body ontouchstart="">
    <div id="menu">
      <!-- <button> -->
      <!--   <svg -->
      <!--     xmlns="http://www.w3.org/2000/svg" -->
      <!--     viewBox="0 0 512 512" -->
      <!--     class="button-icon" -->
      <!--   > -->
      <!--     <path -->
      <!--       d="M495.9 166.6C499.2 175.2 496.4 184.9 489.6 191.2L446.3 230.6C447.4 238.9 448 247.4 448 256C448 264.6 447.4 273.1 446.3 281.4L489.6 320.8C496.4 327.1 499.2 336.8 495.9 345.4C491.5 357.3 486.2 368.8 480.2 379.7L475.5 387.8C468.9 398.8 461.5 409.2 453.4 419.1C447.4 426.2 437.7 428.7 428.9 425.9L373.2 408.1C359.8 418.4 344.1 427 329.2 433.6L316.7 490.7C314.7 499.7 307.7 506.1 298.5 508.5C284.7 510.8 270.5 512 255.1 512C241.5 512 227.3 510.8 213.5 508.5C204.3 506.1 197.3 499.7 195.3 490.7L182.8 433.6C167 427 152.2 418.4 138.8 408.1L83.14 425.9C74.3 428.7 64.55 426.2 58.63 419.1C50.52 409.2 43.12 398.8 36.52 387.8L31.84 379.7C25.77 368.8 20.49 357.3 16.06 345.4C12.82 336.8 15.55 327.1 22.41 320.8L65.67 281.4C64.57 273.1 64 264.6 64 256C64 247.4 64.57 238.9 65.67 230.6L22.41 191.2C15.55 184.9 12.82 175.3 16.06 166.6C20.49 154.7 25.78 143.2 31.84 132.3L36.51 124.2C43.12 113.2 50.52 102.8 58.63 92.95C64.55 85.8 74.3 83.32 83.14 86.14L138.8 103.9C152.2 93.56 167 84.96 182.8 78.43L195.3 21.33C197.3 12.25 204.3 5.04 213.5 3.51C227.3 1.201 241.5 0 256 0C270.5 0 284.7 1.201 298.5 3.51C307.7 5.04 314.7 12.25 316.7 21.33L329.2 78.43C344.1 84.96 359.8 93.56 373.2 103.9L428.9 86.14C437.7 83.32 447.4 85.8 453.4 92.95C461.5 102.8 468.9 113.2 475.5 124.2L480.2 132.3C486.2 143.2 491.5 154.7 495.9 166.6V166.6zM256 336C300.2 336 336 300.2 336 255.1C336 211.8 300.2 175.1 256 175.1C211.8 175.1 176 211.8 176 255.1C176 300.2 211.8 336 256 336z" -->
      <!--     /> -->
      <!--   </svg> -->
      <!-- </button> -->
      <button id="hint" onclick="hint()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 384 512"
          class="button-icon"
        >
          <path
            d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438 0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1h-160L112.1 454.3zM191.4 .0132C89.44 .3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8c16.53 18.84 42.34 58.23 52.22 91.45c.0313 .25 .0938 .5166 .125 .7823h160.2c.0313-.2656 .0938-.5166 .125-.7823c9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1C368 78.61 288.9-.2837 191.4 .0132zM192 96.01c-44.13 0-80 35.89-80 79.1C112 184.8 104.8 192 96 192S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1c8.844 0 16 7.159 16 16S200.8 96.01 192 96.01z"
          />
        </svg>
      </button>
      <div style="flex-grow: 1"></div>
      <button id="restart" onclick="restart()">New Game</button>
    </div>
    <div id="words-container">
      <div id="words"></div>
    </div>
    <div id="letter-bar"></div>
    <script>
      function Game() {
        this.board = new Board();

        this.restart = () => (this.board = new Board());
      }

      function Board() {
        let wordAttempt;
        let filled = false;
        const rand = (upper) => _.random(upper - 1);
        while (!filled) {
          wordAttempt = [[], []];
          try {
            wordAttempt[0].push(word_indices[0][rand(word_indices[0].length)]);
            let wordSlice = wordAttempt[0][0].charAt(1);
            wordAttempt[1].push(
              word_indices[1][wordSlice][
                rand(word_indices[1][wordSlice].length)
              ]
            );
            wordSlice = wordAttempt[0][0].charAt(2);
            wordAttempt[1].push(
              word_indices[1][wordSlice][
                rand(word_indices[1][wordSlice].length)
              ]
            );
            wordSlice = wordAttempt[0][0].charAt(3);
            wordAttempt[1].push(
              word_indices[1][wordSlice][
                rand(word_indices[1][wordSlice].length)
              ]
            );
            wordSlice =
              wordAttempt[1][0].charAt(2) +
              wordAttempt[1][1].charAt(2) +
              wordAttempt[1][2].charAt(2);
            wordAttempt[0].push(
              word_indices[3][wordSlice][
                rand(word_indices[3][wordSlice].length)
              ]
            );
            wordSlice =
              wordAttempt[1][0].charAt(3) +
              wordAttempt[1][1].charAt(3) +
              wordAttempt[1][2].charAt(3);
            wordAttempt[0].push(
              word_indices[3][wordSlice][
                rand(word_indices[3][wordSlice].length)
              ]
            );
            filled = true;
          } catch (e) {
            console.log("failed");
          }
        }
        const letterMatrix = [];
        for (let i = 0; i < 5; i++) {
          letterMatrix.push([]);
          for (let j = 0; j < 5; j++) {
            if (i % 4 === 0 && j % 4 === 0) {
              letterMatrix[i].push("");
            } else if (i === 0) {
              letterMatrix[i].push(wordAttempt[0][j - 1].charAt(0));
            } else if (i === 4) {
              letterMatrix[i].push(wordAttempt[0][j - 1].charAt(4));
            } else {
              letterMatrix[i].push(wordAttempt[1][i - 1].charAt(j));
            }
          }
        }

        this.letterMatrix = letterMatrix;
        this.currentLetterMatrix = letterMatrix.map((letterRow, i) =>
          letterRow.map((letter, j) => {
            if (
              i % (letterMatrix.length - 1) !== 0 &&
              j % (letterRow.length - 1) !== 0
            ) {
              return "";
            } else {
              return letter;
            }
          })
        );

        this.loop = (matrix, fun) => {
          for (let i = 0; i < matrix.length; i++) {
            for (let j = 0; j < matrix[0].length; j++) {
              if (
                i % (matrix.length - 1) !== 0 &&
                j % (matrix[0].length - 1) !== 0
              ) {
                const stop = fun(matrix[i][j], i, j) === "stop";
                if (stop) {
                  return;
                }
              }
            }
          }
        };

        this.focusedIndex = -1;
        this.complete = false;
        const unEnteredLetters = [];
        this.loop(this.letterMatrix, (letter) => {
          unEnteredLetters.push(letter);
        });
        this.shelfLetters = _.shuffle(unEnteredLetters);

        this.getSquare = (i, j, letter, draggable, shelf, shelfIndex) => {
          const square = document.createElement("div");
          square.classList.add("square");
          square.id = letter;
          if (letter) {
            square.classList.add("with-contents");
          }
          if (draggable) {
            square.classList.add("draggable");
            square.onclick = () =>
              this.changeBoard(i, j, letter, shelf, shelfIndex);
            if (!letter) {
              square.classList.add("empty");
            }
            if (this.complete) {
              square.classList.add("complete");
            }
          }
          if (shelf) {
            square.classList.add("shelved");
            if (shelfIndex === this.focusedIndex) {
              square.classList.add("focused");
            }
          }
          const content = document.createElement("div");
          content.classList.add("content");
          content.appendChild(document.createTextNode(letter));
          square.appendChild(content);
          return square;
        };

        this.drawBoard = () => {
          document.getElementById("words").innerHTML = "";
          for (let i = 0; i < this.letterMatrix.length; i++) {
            for (let j = 0; j < this.letterMatrix[0].length; j++) {
              const currentLetter = this.currentLetterMatrix[i][j];
              document
                .getElementById("words")
                .appendChild(
                  this.getSquare(
                    i,
                    j,
                    currentLetter,
                    i % (this.letterMatrix.length - 1) !== 0 &&
                      j % (this.letterMatrix[0].length - 1) !== 0,
                    false
                  )
                );
            }
          }
        };

        this.drawShelf = () => {
          const shelf = document.getElementById("letter-bar");
          shelf.innerHTML = "";
          this.shelfLetters.forEach((letter, i) => {
            shelf.appendChild(this.getSquare(0, 0, letter, true, true, i));
          });
        };

        this.changeBoard = (i, j, letter = "", shelf, shelfIndex) => {
          if (shelf) {
            this.focusedIndex = shelfIndex;
            this.drawShelf();
          } else if (letter) {
            this.currentLetterMatrix[i][j] = "";
            this.shelfLetters.push(letter);
            this.focusedIndex = this.shelfLetters.length - 1;

            this.checkComplete();
            this.drawBoard();
            this.drawShelf();
          } else if (this.focusedIndex !== -1) {
            this.currentLetterMatrix[i][j] =
              this.shelfLetters[this.focusedIndex];
            this.shelfLetters.splice(this.focusedIndex, 1);
            this.focusedIndex = -1;

            this.checkComplete();
            this.drawBoard();
            this.drawShelf();
          }
        };

        this.checkComplete = () => {
          let complete = true;
          this.loop(this.letterMatrix, (letter, i, j) => {
            if (letter !== this.currentLetterMatrix[i][j]) {
              complete = false;
            }
          });
          this.complete = complete;
        };

        this.hint = () => {
          let hintGiven = false;
          let shuffled = _.shuffle(this.shelfLetters);
          shuffled.some((letter) => {
            // if the spot where the letter would go is taken then go to the next letter
            // if the spot is not taken then add it to the spot and mark hint given and return
            this.loop(this.letterMatrix, (currentLetter, i, j) => {
              if (!this.currentLetterMatrix[i][j]) {
                if (letter === currentLetter) {
                  this.currentLetterMatrix[i][j] = currentLetter;
                  const indexToRemove = _.findIndex(
                    this.shelfLetters,
                    (shelfLetter) => shelfLetter === currentLetter
                  );
                  this.shelfLetters.splice(indexToRemove, 1);
                  hintGiven = true;
                  return "stop";
                }
              }
            });
            return hintGiven;
          });
          if (this.shelfLetters.length && !hintGiven) {
            // add the first letter in shelf letters to board and
            // remove the letter that is in it spot and put it in the shelf
            this.loop(this.letterMatrix, (currentLetter, i, j) => {
              if (shuffled[0] === currentLetter) {
                const originalLetter = this.currentLetterMatrix[i][j];
                this.currentLetterMatrix[i][j] = currentLetter;
                const indexToRemove = _.findIndex(
                  this.shelfLetters,
                  (shelfLetter) => shelfLetter === currentLetter
                );
                this.shelfLetters.splice(indexToRemove, 1);
                this.shelfLetters.push(originalLetter);
                return "stop";
              }
            });
          }
          this.checkComplete();
          this.drawShelf();
          this.drawBoard();
        };

        this.shuffle = () => {
          this.shelfLetters = _.shuffle(this.shelfLetters);
          this.drawShelf();
        };

        this.drawBoard();
        this.drawShelf();
        console.log(wordAttempt);
      }

      const game = new Game();

      function hint() {
        game.board.hint();
      }

      function restart() {
        game.restart();
      }

      window.addEventListener("resize", resizeWindow);

      function resizeWindow() {
        const wordsContainer = document.getElementById("words-container");
        const constraint =
          window.innerWidth < window.innerHeight
            ? window.innerWidth
            : window.innerHeight;
        const marginOffset = 3 * 5;
        const maxWidth = constraint - marginOffset;
        const constrainedWidth = maxWidth > 500 ? 500 : maxWidth;
        const fontSize = constrainedWidth / 9 + "px";
        wordsContainer.style.width = constrainedWidth + "px";
        wordsContainer.style.fontSize = fontSize;
        const letterBar = document.getElementById("letter-bar");
        letterBar.style.fontSize = fontSize;
        letterBar.style.width = constrainedWidth + "px";
      }

      resizeWindow();
    </script>
  </body>
</html>
